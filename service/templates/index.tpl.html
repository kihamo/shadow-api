{{ include "frontend" "layout/header.tpl.html" }}

<script src="/js/api/autobahn.min.js"></script>

<style type="text/css">
    table td {
        cursor: pointer;
    }
</style>

<script>
    AUTOBAHN_DEBUG = true;
    var session = null;
    var when;

    try {
        var autobahn = require('autobahn');
        when = require('when');
    } catch (e) {
        when = autobahn.when;
    }

    var connection = new autobahn.Connection({
        url: '{{ .ApiUrl }}',
        realm: 'api'
    });

    connection.onopen = function (s) {
        session = s;
    };
    connection.onclose = function () {
        session = null;
    };

    connection.open();

    $(function () {
        var procedure = $('#procedure');
        var result = $('#result');
        var args = $('#arg .panel-body');
        var argsAdd = $('#arg-add');
        var argsClear = $('#arg-clear');
        var kwargsAdd = $('#kwarg-add');
        var kwargsClear = $('#kwarg-clear');
        var kwargs = $('#kwarg .panel-body');

        function remove() {
            $('.remove').click(function () {
                $(this).parent().remove();

                if (args.is(':empty')){
                    argsAdd.click();
                }

                if (kwargs.is(':empty')){
                    kwargsAdd.click();
                }
            });
        }

        $('table td').click(function () {
            procedure.val($(this).text())

            /*
            argsClear.click();
            kwargsClear.click();
            */
        });

        argsAdd.click(function () {
            var row = $('<div class="form-group form-inline">');
            row.append('<button type="button" class="btn btn-danger btn-small remove"><i class="fa fa-trash-o"></i></button>');
            row.append('<input type="text" class="form-control">');

            args.append(row);
            remove();
        });
        argsClear.click(function () {
            args.empty();
            argsAdd.click();
        });

        kwargsAdd.click(function () {
            var row = $('<div class="form-group form-inline">');
            row.append('<button type="button" class="btn btn-danger btn-small remove"><i class="fa fa-trash-o"></i></button>');
            row.append('<input type="text" class="form-control">');
            row.append('<input type="text" class="form-control">');

            kwargs.append(row);
            remove();
        });
        kwargsClear.click(function () {
            kwargs.empty();
            kwargsAdd.click();
        });

        $('#call').submit(function () {
            var a = [];
            var k = {};

            args.find('input').each(function (i, e) {
                var value = $(e).val();
                if (value.length) {
                    try {
                        value = JSON.parse(value);
                    } catch (e) {
                    }

                    if (typeof value == 'number') {
                        value = '' + value;
                    }

                    a.push(value);
                }
            });
            kwargs.find('input:even').each(function (i, e) {
                var key = $(e).val();
                var value = $(e).next().val();

                if (key.length && value.length) {
                    try {
                        value = JSON.parse(value);
                    } catch (e) {
                    }

                    if (typeof value == 'number') {
                        value = '' + value;
                    }

                    k[key] = value;
                }
            });

            session.call($('#procedure').val(), a, k).then(
                    function (r) {
                        result.find('pre').html(JSON.stringify(r, null, '\t'));
                        result.show();
                    },
                    function (e) {
                        result.find('pre').html(JSON.stringify(e, null, '\t'));
                        result.show();
                    }
            );

            return false;
        });

        remove();
    })
</script>

<div class="panel panel-default">
    <div class="panel-heading">Call procedure</div>
    <div class="panel-body">
        <form id="call">
            <div class="form-group">
                <label for="procedure">Procedure</label>
                <input type="text" class="form-control" id="procedure" required="required"
                       placeholder="{{ (index .Procedures 0).GetName }}">
            </div>

            <div class="row">
                <div class="col-lg-6">
                    <div id="arg" class="panel panel-default">
                        <div class="panel-heading">Args
                            <div class="btn-group pull-right">
                                <button type="button" class="btn btn-success btn-xs" id="arg-add">
                                    <i class="fa fa-plus"></i>
                                </button>
                                <button type="button" class="btn btn-danger btn-xs" id="arg-clear">
                                    <i class="fa fa-trash-o"></i>
                                </button>
                            </div>
                        </div>
                        <div class="panel-body">
                            <div class="form-group form-inline">
                                <button type="button" class="btn btn-danger btn-small remove">
                                    <i class="fa fa-trash-o"></i>
                                </button>
                                <input type="text" class="form-control">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div id="kwarg" class="form-group">
                        <div class="panel panel-default">
                            <div class="panel-heading">Kwargs
                                <div class="btn-group pull-right">
                                    <button type="button" class="btn btn-success btn-xs" id="kwarg-add">
                                        <i class="fa fa-plus"></i>
                                    </button>
                                    <button type="button" class="btn btn-danger btn-xs" id="kwarg-clear">
                                        <i class="fa fa-trash-o"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="panel-body">
                                <div class="form-group form-inline">
                                    <button type="button" class="btn btn-danger btn-small remove">
                                        <i class="fa fa-trash-o"></i>
                                    </button>
                                    <input type="text" class="form-control">
                                    <input type="text" class="form-control">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="text-center">
                <button type="submit" class="btn btn-success">Call procedure</button>
            </div>
            <div id="result" style="display:none">
                <h5>Response</h5>
                <pre></pre>
            </div>
        </form>
    </div>
</div>

<div class="panel panel-default">
    <div class="panel-heading">Procedures</div>
    <div class="panel-body">
        <div class="table-responsive">
        <table class="table table-hover">
            <thead>
            <tr>
                <th>Name</th>
            </tr>
            </thead>
            <tbody>
            {{ range $i, $procedure := .Procedures }}
            <tr>
                <td>{{ $procedure.GetName }}</td>
            </tr>
            {{ end }}
            </tbody>
        </table>
        </div>
    </div>
</div>

{{ include "frontend" "layout/footer.tpl.html" }}